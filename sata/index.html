<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title> Ape |  Tianxiao Gu</title>


    <!-- Styles -->
    <link href="/css/font-awesome.min.css" rel="stylesheet" type="text/css"><!-- font-awesome -->
    <link href="/css/bootstrap.min.css" rel="stylesheet" type="text/css"><!-- Bootstrap -->
    <link href="/css/pygments.css" rel="stylesheet" type="text/css"><!-- Pygments -->
    <link href="/css/moon.css" rel="stylesheet" type="text/css"><!-- moon -->
    <link href="/css/bibtex.css" rel="stylesheet" type="text/css"><!-- bibtex-->
  </head>
  <body role="document">
    <div class="container">
    <h1 id="ape-automated-testing-of-android-applications-with-abstraction-refinement">Ape: Automated Testing of Android Applications with Abstraction Refinement</h1>
<p>Download our model-based automated testing tool <a href="ape-bin.zip">Ape</a>.</p>
<h2 id="install">Install</h2>
<p>Files inside <code>ape-bin.zip</code>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>ape-bin/
ape-bin/ape.jar
ape-bin/ape.py
ape-bin/install.py
ape-bin/README.md
</pre></div>
</td></tr></table>

<p>Just copy the <code>ape.jar</code> to the phone.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>adb push ape.jar /sdcard/
</pre></div>
</td></tr></table>

<h2 id="run">Run</h2>
<p>We provide a python script (i.e., <code>ape.py</code>) to facilitate running ape on Android platform.</p>
<p>The following command starts to run Ape to test the Calculator on a real device connected via <code>adb</code>.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>./ape.py -p com.google.android.calculator --running-minutes 100 --ape sata
</pre></div>
</td></tr></table>

<p>Check the <code>ape.py</code> if you want to run Ape with an emulator.
You should at least remove the <code>-d</code> options for <code>adb</code>.</p>
<p>Options:</p>
<ul>
<li><code>-p</code>: specify the package name, the same as Monkey</li>
<li><code>--running-minutes</code>: the total testing time in minutes<ul>
<li>This is the continuous mode, which means Ape does not stop when it triggers a crash.</li>
</ul>
</li>
<li><code>--ape sata</code>: use the default exploration strategy described in the paper.<ul>
<li>You can also try <code>orbit</code>, <code>wechat</code>, <code>random</code>, and reinforcement learning enhanced random (<code>satarl</code>)</li>
</ul>
</li>
</ul>
<p>You can also specify the total amount of Monkey events. In this mode, Ape will stop by default once there is a crash.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>./ape.py -p com.google.android.calculator --ape sata 1000
</pre></div>
</td></tr></table>

<h2 id="known-bugs">Known Bugs</h2>
<ol>
<li>Memory Bloat:<ul>
<li>Ape runs in the phone with limited memory for each process. Hence it may run out of memory as now we simply keep a large number of Strings and XML document objects in the memory.</li>
</ul>
</li>
</ol>
<h2 id="visualization">Visualization</h2>
<p>We provide a tool to visualize the model.</p>
<ol>
<li>Ape writes several js files into the output folder for visualization.<ul>
<li>Check the tail of the output message to locate the output folder in the phone.</li>
</ul>
</li>
<li><code>adb pull /sdcard/your-output-folder</code> to your local directory.</li>
<li>Copy the following files into the local output directory<ul>
<li><a href="./demo/vis.html">vis.html</a> (Right click and choose 'save as')</li>
<li><a href="./demo/vis.min.css">vis.min.css</a></li>
<li><a href="./demo/vis.min.js">vis.min.js</a></li>
</ul>
</li>
<li>Open the copied <code>vis.html</code> in your browser.<ul>
<li>You may need to wait for a certain amount of time to let the browser render the model.</li>
</ul>
</li>
</ol>
<p>Examples:</p>
<ul>
<li><a href="./demo/vis.html">Calculator</a></li>
<li><a href="./demo-mtxx/vis.html">Meitu</a> (1 min).</li>
</ul>
<p>Now we can check the timeline.</p>
<ul>
<li><a href="./demo-keep-timeline/vis.html">Google Keep</a><ul>
<li><a href="./demo-keep-timeline/vis-timeline.html">Timeline</a></li>
<li>Copy <a href="./demo-keep-timeline/vis-timeline.html">vis-timeline.html</a> to your local output directory.</li>
<li>Open the copied <code>vis-timeline.html</code> in your browser.</li>
</ul>
</li>
</ul>
<h2 id="configuration">Configuration</h2>
<p>Ape is under developing now. There is no stable documentation right now.
After the testing, ape will print a list of configurations.
To change an option,
you can put a Java properties file into <code>/sdcard/ape.properties</code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The documentation below is out-of-date now. Updated documentation will come later.</p>
</div>
<h2 id="model-evolution">Model Evolution</h2>
<p>Naming is a set of XPath based rules to specify how to abstract a GUI tree into a state representation.
The details of a naming is not covered in this document.</p>
<ol>
<li>Disable abstraction refinement:<ul>
<li><code>ape.evolveModel = false</code></li>
<li><code>ape.baseNaming = stoat</code></li>
</ul>
</li>
<li>Enable abstraction refinement:<ul>
<li><code>ape.evolveModel = true</code> (default)</li>
<li><code>ape.baseNaming = resourceid</code> (default)</li>
</ul>
</li>
<li>User specified custom base naming is under working.</li>
</ol>
<p>If you want to use ape as a stress testing tool, you need to disable abstraction refinement
and set a proper wait interval.</p>
<h2 id="action-wait-interval">Action Wait Interval</h2>
<p>An action needs more throttle if it is
1. unvisited
    * <code>ape.throttleForUnvisitedAction = 500</code>
    * An unvisited action usually triggers resource loading and warm up.
2. an activity transition.
    * Rendering a new activity usually needs to wait for more time.
3. visited and non-deterministic (weak transition)
    * Non-deterministic actions usually are caused by canceling a long time GUI transition.</p>
<p>However, the previous rules are heuristic-based. There are a few actions that need a relative long wait interval.
Hence, we randomly append a <code>maxExtraThorttle</code> to an action.</p>
<p>Recommend configuration #1:</p>
<ol>
<li>Use the recommended default throttle.</li>
<li>Smaller regular throttle and large probability to trigger the <code>maxExtraThrottle</code>:<ul>
<li><code>ape.throttleForUnvisitedAction = 100</code></li>
<li><code>ape.throttlePerActivityTransition= 0</code></li>
<li><code>ape.throttlePerWeakStateTransition= 0</code></li>
<li><code>ape.throttlePerTrivialState = 0</code></li>
<li><code>ape.maxExtraThrottleProbability = 0.1</code> (default is 0.01)</li>
</ul>
</li>
<li>Use XPathlet to specify a wait interval for particular actions.</li>
</ol>
<p>Details of how ape calculates the wait interval for an action.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>    private static final int throttleForUnvisitedAction = Config.getInteger(&quot;ape.throttleForUnvisitedAction&quot;, 500); // set base throttle
    private static final int throttlePerActivityTransition = Config.getInteger(&quot;ape.throttlePerActivityTransition&quot;, 200); // set base throttle
    private static final int throttlePerWeakStateTransition =  Config.getInteger(&quot;ape.throttlePerWeakStateTransition&quot;, 500); // false;
    private static final int throttlePerTrivialState = Config.getInteger(&quot;ape.throttlePerTrivialState&quot;, 1000);
    private static final int maxExtraThrottle =  Config.getInteger(&quot;ape.maxExtraThrottle&quot;, 5000);
    private static final int maxThrottle =  Config.getInteger(&quot;ape.maxThrottle&quot;, 5000); // 5 000;

    private static final double maxExtraThrottleProbability = Config.getDouble(&quot;ape.maxExtraThrottleProbability&quot;, 0.01D);
    private static final double maxExtraThrottleProbabilityForActivityTransition = Config.getDouble(&quot;ape.maxExtraThrottleProbabilityForActivityTransition&quot;, 0.10D);

    protected int getThrottleForNewAction(State state, Action action) {
        int throttle = 0;
        Collection&lt;StateTransition&gt; edges = getGraph().getOutStateTransitions(action);
        boolean hasActivityTransition = false;
        boolean hasWeakStateTransition = false;
        boolean hasTrivialState = false;
        for (StateTransition edge : edges) {
            if (edge.action.isBack()) {
                continue;
            }
            if (!edge.isStrong()) {
                hasWeakStateTransition = true;
            } else if (edge.target.isTrivialState()) {}{
                hasTrivialState = true;
            }
            if (!edge.isSameActivity()) {
                hasActivityTransition = true;
            }
        }

        if (hasTrivialState &amp;&amp; edges.size() == 0) {
            throttle += throttlePerTrivialState;
        } else {
            if (hasWeakStateTransition) {
                throttle += throttlePerWeakStateTransition; // only count one weak edge
            }
            if (hasActivityTransition) {
                throttle += throttlePerActivityTransition;
            }
        }
        if (action.isUnvisited()) {
            throttle += throttleForUnvisitedAction;
        }

        if (toss(maxExtraThrottleProbability)) {
            throttle = throttle + getRandom().nextInt(maxExtraThrottle);
        }
        if (hasActivityTransition &amp;&amp; toss(maxExtraThrottleProbabilityForActivityTransition)) {
            throttle = throttle + getRandom().nextInt(maxExtraThrottle);
        }

        throttle =  throttle &lt;= maxThrottle ? throttle : maxThrottle;

        GUITreeNode node = action.getResolvedNode();
        if (node != null) {
            throttle += node.getExtraThrottle(); // via XPath
        }

        if (throttle &gt; 0) {
            Logger.dformat(&quot;Append a throttle %d for action %s&quot;, throttle, action);
        }
        return throttle;
    }
</pre></div>
</td></tr></table>

<h2 id="trap-detection">Trap Detection</h2>
<p>Ape will force the app to be restarted if it detects that it stays in a particular activity/state for a certain number of steps.
In addition, Ape will also restart the app if the graph is not updated for a specific steps.</p>
<p>Check the following options.</p>
<ol>
<li><code>ape.graphStableRestartThreshold</code></li>
<li><code>ape.stateStableRestartThreshold</code></li>
<li><code>ape.activityStableRestartThreshold</code></li>
</ol>
<h2 id="webview">WebView</h2>
<p>The <code>uiautomator dump</code> now support dumping contents into WebView.
But Ape ignores widgets inside a WebView by default.</p>
<p>Check the following options.</p>
<ol>
<li><code>ape.alwaysIgnoreWebViewAction = true</code><ul>
<li>This option will make Ape ignore any WebView.</li>
</ul>
</li>
<li><code>ape.WebViewActionThreshold = 30</code><ul>
<li>This option will make Ape to ignore any WebView that has more than 30 interactive widgets.</li>
</ul>
</li>
</ol>
<h2 id="xpathlet">XPathlet</h2>
<p>Ape now supports configuring widgets-specified behaviors via XPath.</p>
<p>Put the following json into the file <code>/sdcard/ape.xpath</code>.
This will disable actions on any widget that has no text.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>[{
    &quot;xpath&quot;: &quot;//*[@text=&#39;&#39;]&quot;,
    &quot;actions&quot;: []
}]
</pre></div>
</td></tr></table>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Use <a href="https://jsonlint.com/">https://jsonlint.com/</a> to validate your json first.</p>
</div>
<p>The field <code>actions</code> is an array of action names.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>NOP
CLICK
LONG_CLICK
SCROLL_TOP_DOWN
SCROLL_BOTTOM_UP
SCROLL_LEFT_RIGHT
SCROLL_RIGHT_LEFT
</pre></div>
</td></tr></table>

<h2 id="screenshots">Screenshots</h2>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>ape.takeScreenshot = true
ape.takeScreenshotForEveryStep = true
ape.takeScreenshotForNewState = true
ape.imageWriterCount = 3
</pre></div>
</td></tr></table>

<h2 id="input-text">Input Text</h2>
<p>Ape decides to do text input by checking the following three conditions.</p>
<ol>
<li>
<p>Specified by XPath</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>[{
    &quot;xpath&quot;: &quot;//*[@text=&#39;Title&#39;]&quot;,
    &quot;text&quot;: &quot;I am a Title&quot;
}]
</pre></div>
</td></tr></table>

<p>An example of testing the Google Keep app can be found here.</p>
<ul>
<li><a href="./xpath-input-example/vis-timeline.html">vis-timeline.html</a></li>
</ul>
<p>This feature depends on the <a href="https://github.com/senzhk/ADBKeyBoard">ADB Keyboard</a>. You must build and install a ADBKeyboard first.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>ADB Keyboard cannot properly handle <code>imeOptions</code>. To avoid unnecessary crashes, we now only do text input but disable IME actions.
More information can be found at <a href="https://developer.android.com/reference/android/view/inputmethod/EditorInfo.html">https://developer.android.com/reference/android/view/inputmethod/EditorInfo.html</a>.</p>
</div>
</li>
<li>
<p><code>ape.randomPickFromStringList = true</code></p>
<ul>
<li>Randomly pick a line from a text file located at <code>/sdcard/ape.strings</code>.</li>
</ul>
</li>
<li><code>ape.generateRandomTextInput = true</code><ul>
<li>Randomly generate a string by regex <code>[0-9a-z]{0,32}</code>.</li>
</ul>
</li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Only one type of input action can be triggered.</p>
</div>
<h2 id="acknowledgments">Acknowledgments</h2>
<p>We thank the following experts for their insightful comments on Ape.</p>
<ul>
<li><a href="https://tingsu.github.io/">Ting Su</a></li>
<li>Zhao Zhang 张钊</li>
</ul>
    </div>

    <footer class="footer" style="margin-top:10px;">
      <div class="container">
          <span class="text-muted">&copy; 2017 <a href="/">Tianxiao Gu</a>. All rights reserved.</span>
      <div style="width:70px;height:48px;">
      <script type='text/javascript' id='clustrmaps' src='//cdn.clustrmaps.com/map_v2.js?cl=ffffff&w=70&t=n&d=I1T5oEaSW-FJIJ_bZCvK8XMDQ35ouGHQP_ixsLYwvOo'></script></div>
      </div>
    </footer>

    <!-- jQuery -->
    <script src="/js/jquery-3.2.1.min.js"></script>
    <script src="/js/jquery-migrate-1.4.1.min.js"></script>
    <!-- Bootstrap -->
    <script src="/js/bootstrap.min.js"></script>

    

    
  </body>
</html>